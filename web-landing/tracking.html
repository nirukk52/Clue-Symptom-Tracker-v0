<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KFK8WHV5');</script>
    <!-- End Google Tag Manager -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Campaign Tracking - Chronic Life</title>
    <meta name="robots" content="noindex, nofollow" />

    <!-- Fonts: Match landing page -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=Fraunces:opsz,wght@9..144,300;9..144,400;9..144,500;9..144,600;9..144,700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&display=swap"
      rel="stylesheet"
    />

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#20132E',
              'primary-light': '#f3f0fa',
              'bg-cream': '#FDFBF9',
              'bg-card': '#FFFFFF',
              'accent-peach': '#E8974F',
              'accent-blue': '#A4C8D8',
              'accent-purple': '#D0BDF4',
              'accent-mint': '#B8E3D6',
              'accent-rose': '#F4C4C4',
              'text-main': '#20132E',
              'text-muted': '#554b66',
            },
            fontFamily: {
              display: ['Fraunces', 'Georgia', 'serif'],
              body: ['DM Sans', 'system-ui', 'sans-serif'],
            },
          },
        },
      };
    </script>
    <style>
      body {
        font-family: 'DM Sans', sans-serif;
      }
      .font-display {
        font-family: 'Fraunces', Georgia, serif;
      }

      /* Password overlay */
      .password-overlay {
        position: fixed;
        inset: 0;
        background: rgba(32, 19, 46, 0.95);
        backdrop-filter: blur(8px);
        z-index: 100;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .password-overlay.hidden {
        display: none;
      }

      /* Loading spinner */
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .animate-spin {
        animation: spin 1s linear infinite;
      }

      /* Table styles */
      .metric-good {
        color: #10b981;
      }
      .metric-okay {
        color: #f59e0b;
      }
      .metric-bad {
        color: #ef4444;
      }

      /* Modal overlay */
      .referrer-modal {
        position: fixed;
        inset: 0;
        background: rgba(32, 19, 46, 0.95);
        backdrop-filter: blur(8px);
        z-index: 200;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
      }
      .referrer-modal.hidden {
        display: none;
      }
      .referrer-modal-content {
        background: white;
        border-radius: 24px;
        max-width: 800px;
        width: 100%;
        max-height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }
      .campaign-row-clickable {
        cursor: pointer;
      }
      .campaign-row-clickable:hover {
        background-color: rgba(243, 240, 250, 0.7) !important;
      }
    </style>
  </head>
  <body class="bg-bg-cream text-text-main antialiased min-h-screen">
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KFK8WHV5"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    
    <!-- Password Gate -->
    <div class="password-overlay" id="passwordOverlay">
      <div class="bg-white rounded-3xl p-8 shadow-xl max-w-sm w-full mx-4">
        <div class="text-center mb-6">
          <div
            class="w-14 h-14 rounded-2xl bg-accent-purple/20 flex items-center justify-center mx-auto mb-4"
          >
            <span class="material-symbols-outlined text-primary text-2xl"
              >lock</span
            >
          </div>
          <h1 class="font-display text-2xl font-semibold text-primary mb-2">
            Campaign Dashboard
          </h1>
          <p class="text-text-muted text-sm">
            Enter password to view tracking data
          </p>
        </div>
        <form id="passwordForm">
          <input
            type="password"
            id="passwordInput"
            class="w-full px-4 py-3 rounded-full border-2 border-primary/10 focus:border-accent-purple focus:outline-none mb-4"
            placeholder="Password"
            autofocus
          />
          <p id="passwordError" class="text-accent-peach text-sm mb-4 hidden">
            Incorrect password
          </p>
          <button
            type="submit"
            class="w-full bg-primary text-white font-bold py-3 rounded-full hover:bg-primary/90 transition-colors"
          >
            Access Dashboard
          </button>
        </form>
      </div>
    </div>

    <!-- Dashboard Content -->
    <div
      class="max-w-6xl mx-auto px-6 py-12"
      id="dashboardContent"
      style="display: none"
    >
      <!-- Header -->
      <div class="flex items-center justify-between mb-8">
        <div>
          <h1 class="font-display text-3xl font-semibold text-primary mb-2">
            Campaign Tracking
          </h1>
          <p class="text-text-muted">Reddit ad performance for Chronic Life</p>
        </div>
        <button
          onclick="refreshData()"
          class="flex items-center gap-2 px-4 py-2 bg-white border border-primary/10 rounded-full hover:bg-primary-light transition-colors"
        >
          <span class="material-symbols-outlined text-lg" id="refreshIcon"
            >refresh</span
          >
          Refresh
        </button>
      </div>

      <!-- Summary Cards -->
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">
        <div class="bg-white rounded-2xl p-6 border border-primary/5">
          <p class="text-text-muted text-sm mb-1">Total Views</p>
          <p
            class="font-display text-3xl font-bold text-primary"
            id="totalViews"
          >
            -
          </p>
        </div>
        <div class="bg-white rounded-2xl p-6 border border-primary/5">
          <p class="text-text-muted text-sm mb-1">CTA Clicks</p>
          <p
            class="font-display text-3xl font-bold text-primary"
            id="totalClicks"
          >
            -
          </p>
        </div>
        <div class="bg-white rounded-2xl p-6 border border-primary/5">
          <p class="text-text-muted text-sm mb-1">Signups</p>
          <p
            class="font-display text-3xl font-bold text-accent-mint"
            id="totalSignups"
          >
            -
          </p>
        </div>
        <div class="bg-white rounded-2xl p-6 border border-primary/5">
          <p class="text-text-muted text-sm mb-1">Conversion Rate</p>
          <p
            class="font-display text-3xl font-bold text-accent-peach"
            id="conversionRate"
          >
            -
          </p>
        </div>
        <div class="bg-white rounded-2xl p-6 border border-primary/5">
          <p class="text-text-muted text-sm mb-1">Null Referrer</p>
          <p
            class="font-display text-3xl font-bold text-accent-blue"
            id="nullReferrer"
          >
            -
          </p>
        </div>
        <div class="bg-white rounded-2xl p-6 border border-primary/5">
          <p class="text-text-muted text-sm mb-1">Other Referrer</p>
          <p
            class="font-display text-3xl font-bold text-accent-purple"
            id="otherReferrer"
          >
            -
          </p>
        </div>
      </div>

      <!-- Campaign Table -->
      <div
        class="bg-white rounded-3xl border border-primary/5 overflow-hidden mb-8"
      >
        <div class="px-6 py-4 border-b border-primary/5">
          <h2 class="font-display text-xl font-semibold text-primary">
            Campaign Performance
          </h2>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-bg-cream">
              <tr>
                <th
                  class="px-6 py-3 text-left text-sm font-semibold text-text-muted"
                >
                  Campaign
                </th>
                <th
                  class="px-6 py-3 text-left text-sm font-semibold text-text-muted"
                >
                  Content
                </th>
                <th
                  class="px-6 py-3 text-right text-sm font-semibold text-text-muted"
                >
                  Views
                </th>
                <th
                  class="px-6 py-3 text-right text-sm font-semibold text-text-muted"
                >
                  Clicks
                </th>
                <th
                  class="px-6 py-3 text-right text-sm font-semibold text-text-muted"
                >
                  Signups
                </th>
                <th
                  class="px-6 py-3 text-right text-sm font-semibold text-text-muted"
                >
                  Click Rate
                </th>
                <th
                  class="px-6 py-3 text-right text-sm font-semibold text-text-muted"
                >
                  Conv Rate
                </th>
                <th
                  class="px-6 py-3 text-right text-sm font-semibold text-text-muted"
                >
                  Null Referrer
                </th>
                <th
                  class="px-6 py-3 text-right text-sm font-semibold text-text-muted"
                >
                  Other Referrer
                </th>
              </tr>
            </thead>
            <tbody id="campaignTable">
              <tr>
                <td colspan="9" class="px-6 py-8 text-center text-text-muted">
                  <span class="material-symbols-outlined animate-spin"
                    >progress_activity</span
                  >
                  <p class="mt-2">Loading data...</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- CTA Clicks by Page -->
      <div
        class="bg-white rounded-3xl border border-primary/5 overflow-hidden mb-8"
      >
        <div class="px-6 py-4 border-b border-primary/5">
          <h2 class="font-display text-xl font-semibold text-primary">
            CTA Clicks by Page
          </h2>
          <p class="text-text-muted text-sm mt-1">
            Which buttons are getting clicks on each landing page
          </p>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-bg-cream">
              <tr>
                <th
                  class="px-6 py-3 text-left text-sm font-semibold text-text-muted"
                >
                  Page
                </th>
                <th
                  class="px-6 py-3 text-left text-sm font-semibold text-text-muted"
                >
                  CTA Button
                </th>
                <th
                  class="px-6 py-3 text-left text-sm font-semibold text-text-muted"
                >
                  Element ID
                </th>
                <th
                  class="px-6 py-3 text-right text-sm font-semibold text-text-muted"
                >
                  Clicks
                </th>
                <th
                  class="px-6 py-3 text-right text-sm font-semibold text-text-muted"
                >
                  % of Total
                </th>
              </tr>
            </thead>
            <tbody id="ctaClicksTable">
              <tr>
                <td colspan="5" class="px-6 py-8 text-center text-text-muted">
                  <span class="material-symbols-outlined animate-spin"
                    >progress_activity</span
                  >
                  <p class="mt-2">Loading data...</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Recent Signups -->
      <div class="bg-white rounded-3xl border border-primary/5 overflow-hidden">
        <div class="px-6 py-4 border-b border-primary/5">
          <h2 class="font-display text-xl font-semibold text-primary">
            Recent Signups
          </h2>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-bg-cream">
              <tr>
                <th
                  class="px-6 py-3 text-left text-sm font-semibold text-text-muted"
                >
                  Email
                </th>
                <th
                  class="px-6 py-3 text-left text-sm font-semibold text-text-muted"
                >
                  Campaign
                </th>
                <th
                  class="px-6 py-3 text-left text-sm font-semibold text-text-muted"
                >
                  Content
                </th>
                <th
                  class="px-6 py-3 text-left text-sm font-semibold text-text-muted"
                >
                  Source
                </th>
                <th
                  class="px-6 py-3 text-left text-sm font-semibold text-text-muted"
                >
                  Date
                </th>
              </tr>
            </thead>
            <tbody id="signupsTable">
              <tr>
                <td colspan="5" class="px-6 py-8 text-center text-text-muted">
                  <span class="material-symbols-outlined animate-spin"
                    >progress_activity</span
                  >
                  <p class="mt-2">Loading data...</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Footer -->
      <div class="text-center mt-8 text-text-muted text-sm">
        <p>Last updated: <span id="lastUpdated">-</span></p>
      </div>
    </div>

    <!-- Referrer Details Modal -->
    <div class="referrer-modal hidden" id="referrerModal">
      <div class="referrer-modal-content">
        <div
          class="px-6 py-4 border-b border-primary/5 flex items-center justify-between"
        >
          <div>
            <h2
              class="font-display text-xl font-semibold text-primary"
              id="modalTitle"
            >
              Referrer Breakdown
            </h2>
            <p class="text-text-muted text-sm mt-1" id="modalSubtitle">-</p>
          </div>
          <button
            onclick="closeReferrerModal()"
            class="p-2 hover:bg-primary-light rounded-full transition-colors"
          >
            <span class="material-symbols-outlined text-primary">close</span>
          </button>
        </div>
        <div class="overflow-y-auto flex-1 px-6 py-4">
          <div id="referrerBreakdown">
            <p class="text-text-muted text-center py-8">Loading...</p>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ===== CONFIG =====
      const SUPABASE_URL = 'https://zvpudxinbcsrfyojrhhv.supabase.co';
      const SUPABASE_ANON_KEY =
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp2cHVkeGluYmNzcmZ5b2pyaGh2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5NTE3MjksImV4cCI6MjA4MjUyNzcyOX0.5vV65qusPzu7847VxbiodRU0DZG1AryUuoklX3qFAWk';
      const DASHBOARD_PASSWORD = 'chroniclife2025';

      const supabaseClient = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY
      );

      // Store events and signups globally for referrer breakdown
      let allEvents = [];
      let allSignups = [];

      // ===== PASSWORD GATE =====
      const passwordOverlay = document.getElementById('passwordOverlay');
      const passwordForm = document.getElementById('passwordForm');
      const passwordInput = document.getElementById('passwordInput');
      const passwordError = document.getElementById('passwordError');
      const dashboardContent = document.getElementById('dashboardContent');

      // Check if already authenticated
      if (sessionStorage.getItem('dashboard_auth') === 'true') {
        passwordOverlay.classList.add('hidden');
        dashboardContent.style.display = 'block';
        loadDashboardData();
      }

      passwordForm.addEventListener('submit', function (e) {
        e.preventDefault();
        if (passwordInput.value === DASHBOARD_PASSWORD) {
          sessionStorage.setItem('dashboard_auth', 'true');
          passwordOverlay.classList.add('hidden');
          dashboardContent.style.display = 'block';
          loadDashboardData();
        } else {
          passwordError.classList.remove('hidden');
          passwordInput.classList.add('border-accent-peach');
        }
      });

      // ===== DATA LOADING =====
      async function loadDashboardData() {
        try {
          // Fetch events
          const { data: events, error: eventsError } = await supabaseClient
            .from('marketing_events')
            .select('*')
            .order('created_at', { ascending: false });

          // Fetch signups
          const { data: signups, error: signupsError } = await supabaseClient
            .from('beta_signups')
            .select('*')
            .order('created_at', { ascending: false });

          if (eventsError) throw eventsError;
          if (signupsError) throw signupsError;

          // Store globally for referrer breakdown
          allEvents = events || [];
          allSignups = signups || [];

          renderDashboard(allEvents, allSignups);
          document.getElementById('lastUpdated').textContent =
            new Date().toLocaleString();
        } catch (err) {
          console.error('Error loading data:', err);
          document.getElementById('campaignTable').innerHTML = `
          <tr>
            <td colspan="9" class="px-6 py-8 text-center text-accent-peach">
              Error loading data. Check console for details.
            </td>
          </tr>
        `;
        }
      }

      function renderDashboard(events, signups) {
        // Calculate totals
        const pageViews = events.filter((e) => e.event_type === 'page_view');
        const clicks = events.filter((e) => e.event_type === 'cta_click');

        document.getElementById('totalViews').textContent = pageViews.length;
        document.getElementById('totalClicks').textContent = clicks.length;
        document.getElementById('totalSignups').textContent = signups.length;

        // Render CTA clicks breakdown
        renderCtaClicksTable(clicks);

        const convRate =
          clicks.length > 0
            ? ((signups.length / clicks.length) * 100).toFixed(1) + '%'
            : '0%';
        document.getElementById('conversionRate').textContent = convRate;

        // Calculate referrer counts
        const allReferrers = [
          ...events.map((e) => e.referrer),
          ...signups.map((s) => s.referrer),
        ];
        const nullReferrerCount = allReferrers.filter(
          (r) => !r || r === null || r === ''
        ).length;
        const otherReferrerCount = allReferrers.filter(
          (r) => r && r !== null && r !== ''
        ).length;

        document.getElementById('nullReferrer').textContent = nullReferrerCount;
        document.getElementById('otherReferrer').textContent =
          otherReferrerCount;

        // Group by campaign + content
        const campaigns = {};

        // Process page views
        pageViews.forEach((e) => {
          const key = `${e.utm_campaign || 'direct'}|${e.utm_content || 'none'}`;
          if (!campaigns[key]) {
            campaigns[key] = {
              campaign: e.utm_campaign || 'Direct',
              content: e.utm_content || '-',
              views: 0,
              clicks: 0,
              signups: 0,
              nullReferrer: 0,
              otherReferrer: 0,
            };
          }
          campaigns[key].views++;
          // Count referrer for this event
          if (!e.referrer || e.referrer === null || e.referrer === '') {
            campaigns[key].nullReferrer++;
          } else {
            campaigns[key].otherReferrer++;
          }
        });

        // Process clicks
        clicks.forEach((e) => {
          const key = `${e.utm_campaign || 'direct'}|${e.utm_content || 'none'}`;
          if (!campaigns[key]) {
            campaigns[key] = {
              campaign: e.utm_campaign || 'Direct',
              content: e.utm_content || '-',
              views: 0,
              clicks: 0,
              signups: 0,
              nullReferrer: 0,
              otherReferrer: 0,
            };
          }
          campaigns[key].clicks++;
          // Count referrer for this event
          if (!e.referrer || e.referrer === null || e.referrer === '') {
            campaigns[key].nullReferrer++;
          } else {
            campaigns[key].otherReferrer++;
          }
        });

        // Process signups
        signups.forEach((s) => {
          const key = `${s.utm_campaign || 'direct'}|${s.utm_content || 'none'}`;
          if (!campaigns[key]) {
            campaigns[key] = {
              campaign: s.utm_campaign || 'Direct',
              content: s.utm_content || '-',
              views: 0,
              clicks: 0,
              signups: 0,
              nullReferrer: 0,
              otherReferrer: 0,
            };
          }
          campaigns[key].signups++;
          // Count referrer for this signup
          if (!s.referrer || s.referrer === null || s.referrer === '') {
            campaigns[key].nullReferrer++;
          } else {
            campaigns[key].otherReferrer++;
          }
        });

        // Render campaign table
        const campaignData = Object.values(campaigns).sort(
          (a, b) => b.signups - a.signups
        );

        if (campaignData.length === 0) {
          document.getElementById('campaignTable').innerHTML = `
          <tr>
            <td colspan="9" class="px-6 py-8 text-center text-text-muted">
              No data yet. Run some ads!
            </td>
          </tr>
        `;
        } else {
          document.getElementById('campaignTable').innerHTML = campaignData
            .map((c) => {
              const clickRate =
                c.views > 0 ? ((c.clicks / c.views) * 100).toFixed(1) : 0;
              const convRate =
                c.clicks > 0 ? ((c.signups / c.clicks) * 100).toFixed(1) : 0;

              const clickRateClass =
                clickRate >= 15
                  ? 'metric-good'
                  : clickRate >= 5
                    ? 'metric-okay'
                    : 'metric-bad';
              const convRateClass =
                convRate >= 10
                  ? 'metric-good'
                  : convRate >= 3
                    ? 'metric-okay'
                    : 'metric-bad';

              const rowKey = `${c.campaign}|${c.content}`;
              // Encode for HTML attributes (escape quotes)
              const campaignData = (c.campaign || 'Direct').replace(
                /"/g,
                '&quot;'
              );
              const contentData = (c.content || '-').replace(/"/g, '&quot;');
              return `
            <tr class="border-b border-primary/5 campaign-row-clickable"
                data-campaign="${campaignData}"
                data-content="${contentData}">
              <td class="px-6 py-4 font-medium text-primary">${escapeHtml(c.campaign)}</td>
              <td class="px-6 py-4 text-text-muted">${escapeHtml(c.content)}</td>
              <td class="px-6 py-4 text-right">${c.views}</td>
              <td class="px-6 py-4 text-right">${c.clicks}</td>
              <td class="px-6 py-4 text-right font-semibold">${c.signups}</td>
              <td class="px-6 py-4 text-right ${clickRateClass}">${clickRate}%</td>
              <td class="px-6 py-4 text-right ${convRateClass}">${convRate}%</td>
              <td class="px-6 py-4 text-right text-accent-blue">${c.nullReferrer}</td>
              <td class="px-6 py-4 text-right text-accent-purple">${c.otherReferrer}</td>
            </tr>
          `;
            })
            .join('');

          // Add click handlers to campaign rows
          document
            .querySelectorAll('.campaign-row-clickable')
            .forEach((row) => {
              row.addEventListener('click', function () {
                const campaign = this.dataset.campaign;
                const content = this.dataset.content;
                showReferrerBreakdown(campaign, content);
              });
            });
        }

        // Render signups table (last 20)
        const recentSignups = signups.slice(0, 20);

        if (recentSignups.length === 0) {
          document.getElementById('signupsTable').innerHTML = `
          <tr>
            <td colspan="5" class="px-6 py-8 text-center text-text-muted">
              No signups yet. Keep pushing!
            </td>
          </tr>
        `;
        } else {
          document.getElementById('signupsTable').innerHTML = recentSignups
            .map((s) => {
              const date = new Date(s.created_at).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
              });
              return `
            <tr class="border-b border-primary/5 hover:bg-bg-cream/50">
              <td class="px-6 py-4 font-medium text-primary">${escapeHtml(s.email)}</td>
              <td class="px-6 py-4">${escapeHtml(s.utm_campaign || 'Direct')}</td>
              <td class="px-6 py-4 text-text-muted">${escapeHtml(s.utm_content || '-')}</td>
              <td class="px-6 py-4 text-text-muted">${escapeHtml(s.utm_source || 'Direct')}</td>
              <td class="px-6 py-4 text-text-muted">${date}</td>
            </tr>
          `;
            })
            .join('');
        }
      }

      function refreshData() {
        const icon = document.getElementById('refreshIcon');
        icon.classList.add('animate-spin');
        loadDashboardData().then(() => {
          setTimeout(() => icon.classList.remove('animate-spin'), 500);
        });
      }

      function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // ===== CTA CLICKS BREAKDOWN =====
      function renderCtaClicksTable(clicks) {
        const totalClicks = clicks.length;

        if (totalClicks === 0) {
          document.getElementById('ctaClicksTable').innerHTML = `
          <tr>
            <td colspan="5" class="px-6 py-8 text-center text-text-muted">
              No CTA clicks recorded yet.
            </td>
          </tr>
        `;
          return;
        }

        // Group clicks by page + element
        const ctaGroups = {};

        clicks.forEach((click) => {
          // Extract page name from URL
          const pageName = extractPageName(click.page_url);
          const elementId = click.element_id || 'unknown';
          const elementText =
            cleanElementText(click.element_text) || 'Unknown Button';

          const key = `${pageName}|${elementId}|${elementText}`;

          if (!ctaGroups[key]) {
            ctaGroups[key] = {
              page: pageName,
              elementId: elementId,
              elementText: elementText,
              clicks: 0,
            };
          }
          ctaGroups[key].clicks++;
        });

        // Sort by clicks descending
        const sortedGroups = Object.values(ctaGroups).sort(
          (a, b) => b.clicks - a.clicks
        );

        // Render table
        document.getElementById('ctaClicksTable').innerHTML = sortedGroups
          .map((g) => {
            const percentage = ((g.clicks / totalClicks) * 100).toFixed(1);
            const percentClass =
              percentage >= 20
                ? 'metric-good'
                : percentage >= 10
                  ? 'metric-okay'
                  : '';

            // Color code by page
            const pageColor = getPageColor(g.page);

            return `
          <tr class="border-b border-primary/5 hover:bg-bg-cream/50">
            <td class="px-6 py-4">
              <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${pageColor}">
                ${escapeHtml(g.page)}
              </span>
            </td>
            <td class="px-6 py-4 font-medium text-primary">${escapeHtml(g.elementText)}</td>
            <td class="px-6 py-4 text-text-muted font-mono text-sm">${escapeHtml(g.elementId)}</td>
            <td class="px-6 py-4 text-right font-semibold text-primary">${g.clicks}</td>
            <td class="px-6 py-4 text-right ${percentClass}">${percentage}%</td>
          </tr>
        `;
          })
          .join('');
      }

      function extractPageName(url) {
        if (!url) return 'Unknown';

        try {
          const urlObj = new URL(url);
          const pathname = urlObj.pathname;

          // Map common paths to friendly names
          const pageMap = {
            '/': 'Homepage',
            '/index.html': 'Homepage',
            '/spoon-saver': 'Spoon Saver',
            '/spoon-saver.html': 'Spoon Saver',
            '/predict-flares': 'Predict Flares',
            '/predict-flares.html': 'Predict Flares',
            '/foggy-minds': 'Foggy Minds',
            '/foggy-minds.html': 'Foggy Minds',
            '/appointment-prep': 'Appointment Prep',
            '/appointment-prep.html': 'Appointment Prep',
            '/doctor-proof': 'Doctor Proof',
            '/doctor-proof.html': 'Doctor Proof',
            '/find-triggers': 'Find Triggers',
            '/find-triggers.html': 'Find Triggers',
          };

          return pageMap[pathname] || pathname.replace(/\//g, '') || 'Homepage';
        } catch (e) {
          return 'Unknown';
        }
      }

      function cleanElementText(text) {
        if (!text) return '';
        // Remove material icon names (including truncated versions) and extra whitespace
        return text
          .replace(/arrow_\w*/gi, '') // Handles arrow_forward, arrow_forwa, arrow_back, etc.
          .replace(/\s+/g, ' ')
          .trim();
      }

      function getPageColor(pageName) {
        const colorMap = {
          Homepage: 'bg-accent-purple/20 text-primary',
          'Spoon Saver': 'bg-accent-peach/20 text-accent-peach',
          'Predict Flares': 'bg-accent-blue/20 text-blue-700',
          'Foggy Minds': 'bg-accent-mint/20 text-green-700',
          'Appointment Prep': 'bg-accent-rose/20 text-rose-700',
          'Doctor Proof': 'bg-yellow-100 text-yellow-700',
          'Find Triggers': 'bg-indigo-100 text-indigo-700',
        };
        return colorMap[pageName] || 'bg-primary-light text-primary';
      }

      // ===== REFERRER BREAKDOWN MODAL =====
      function showReferrerBreakdown(campaign, content) {
        const modal = document.getElementById('referrerModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalSubtitle = document.getElementById('modalSubtitle');
        const breakdown = document.getElementById('referrerBreakdown');

        // Set title
        modalTitle.textContent = 'Referrer Breakdown';
        modalSubtitle.textContent = `${campaign} - ${content}`;

        // Filter events and signups by campaign and content
        const campaignEvents = allEvents.filter((e) => {
          const eCampaign = e.utm_campaign || 'Direct';
          const eContent = e.utm_content || '-';
          return eCampaign === campaign && eContent === content;
        });

        const campaignSignups = allSignups.filter((s) => {
          const sCampaign = s.utm_campaign || 'Direct';
          const sContent = s.utm_content || '-';
          return sCampaign === campaign && sContent === content;
        });

        // Collect all referrers
        const allReferrers = [
          ...campaignEvents.map((e) => e.referrer),
          ...campaignSignups.map((s) => s.referrer),
        ];

        // Group referrers by value and count
        const referrerCounts = {};
        allReferrers.forEach((ref) => {
          const key = ref || null;
          referrerCounts[key] = (referrerCounts[key] || 0) + 1;
        });

        // Sort by count (descending)
        const sortedReferrers = Object.entries(referrerCounts)
          .map(([ref, count]) => ({ referrer: ref, count }))
          .sort((a, b) => b.count - a.count);

        // Render breakdown
        if (sortedReferrers.length === 0) {
          breakdown.innerHTML = `
          <p class="text-text-muted text-center py-8">No referrer data available for this campaign.</p>
        `;
        } else {
          breakdown.innerHTML = `
          <div class="space-y-3">
            ${sortedReferrers
              .map((r) => {
                const displayRef =
                  r.referrer === null || r.referrer === ''
                    ? '<span class="text-text-muted italic">null</span>'
                    : escapeHtml(r.referrer);
                return `
                <div class="flex items-center justify-between p-4 bg-bg-cream rounded-xl border border-primary/5">
                  <div class="flex-1 min-w-0">
                    <p class="text-sm text-text-muted mb-1">Referrer</p>
                    <p class="font-medium text-primary break-all">${displayRef}</p>
                  </div>
                  <div class="ml-4 text-right">
                    <p class="text-sm text-text-muted mb-1">Count</p>
                    <p class="font-display text-2xl font-bold text-accent-purple">${r.count}</p>
                  </div>
                </div>
              `;
              })
              .join('')}
          </div>
        `;
        }

        modal.classList.remove('hidden');
      }

      function closeReferrerModal() {
        document.getElementById('referrerModal').classList.add('hidden');
      }

      // Close modal on outside click (setup after DOM is ready)
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', setupModalClose);
      } else {
        setupModalClose();
      }

      function setupModalClose() {
        const modal = document.getElementById('referrerModal');
        if (modal) {
          modal.addEventListener('click', function (e) {
            if (e.target === this) {
              closeReferrerModal();
            }
          });
        }
      }
    </script>
  </body>
</html>
