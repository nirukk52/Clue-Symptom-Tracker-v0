<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <!-- Google Tag Manager -->
    <script>
      (function (w, d, s, l, i) {
        w[l] = w[l] || [];
        w[l].push({ 'gtm.start': new Date().getTime(), event: 'gtm.js' });
        var f = d.getElementsByTagName(s)[0],
          j = d.createElement(s),
          dl = l != 'dataLayer' ? '&l=' + l : '';
        j.async = true;
        j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
        f.parentNode.insertBefore(j, f);
      })(window, document, 'script', 'dataLayer', 'GTM-KFK8WHV5');
    </script>
    <!-- End Google Tag Manager -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Campaign Tracking - Chronic Life</title>
    <meta name="robots" content="noindex, nofollow" />

    <!-- Fonts: Match landing page -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=Fraunces:opsz,wght@9..144,300;9..144,400;9..144,500;9..144,600;9..144,700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&display=swap"
      rel="stylesheet"
    />

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#20132E',
              'primary-light': '#f3f0fa',
              'bg-cream': '#FDFBF9',
              'bg-card': '#FFFFFF',
              'accent-peach': '#E8974F',
              'accent-blue': '#A4C8D8',
              'accent-purple': '#D0BDF4',
              'accent-mint': '#B8E3D6',
              'accent-rose': '#F4C4C4',
              'text-main': '#20132E',
              'text-muted': '#554b66',
            },
            fontFamily: {
              display: ['Fraunces', 'Georgia', 'serif'],
              body: ['DM Sans', 'system-ui', 'sans-serif'],
            },
          },
        },
      };
    </script>
    <style>
      body {
        font-family: 'DM Sans', sans-serif;
      }
      .font-display {
        font-family: 'Fraunces', Georgia, serif;
      }

      /* Password overlay */
      .password-overlay {
        position: fixed;
        inset: 0;
        background: rgba(32, 19, 46, 0.95);
        backdrop-filter: blur(8px);
        z-index: 100;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .password-overlay.hidden {
        display: none;
      }

      /* Loading spinner */
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .animate-spin {
        animation: spin 1s linear infinite;
      }

      /* Table styles */
      .metric-good {
        color: #10b981;
      }
      .metric-okay {
        color: #f59e0b;
      }
      .metric-bad {
        color: #ef4444;
      }

      /* Modal overlay */
      .referrer-modal {
        position: fixed;
        inset: 0;
        background: rgba(32, 19, 46, 0.95);
        backdrop-filter: blur(8px);
        z-index: 200;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
      }
      .referrer-modal.hidden {
        display: none;
      }
      .referrer-modal-content {
        background: white;
        border-radius: 24px;
        max-width: 800px;
        width: 100%;
        max-height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }
      .campaign-row-clickable {
        cursor: pointer;
      }
      .campaign-row-clickable:hover {
        background-color: rgba(243, 240, 250, 0.7) !important;
      }

      /* User row clickable */
      .user-row-clickable {
        cursor: pointer;
        transition: all 0.15s ease;
      }
      .user-row-clickable:hover {
        background-color: rgba(208, 189, 244, 0.2) !important;
      }

      /* User journey modal */
      .user-modal {
        position: fixed;
        inset: 0;
        background: rgba(32, 19, 46, 0.95);
        backdrop-filter: blur(8px);
        z-index: 200;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
      }
      .user-modal.hidden {
        display: none;
      }
      .user-modal-content {
        background: white;
        border-radius: 24px;
        max-width: 700px;
        width: 100%;
        max-height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      /* Journey timeline */
      .journey-timeline {
        position: relative;
        padding-left: 2rem;
      }
      .journey-timeline::before {
        content: '';
        position: absolute;
        left: 0.5rem;
        top: 0;
        bottom: 0;
        width: 2px;
        background: linear-gradient(to bottom, #d0bdf4, #b8e3d6);
        border-radius: 2px;
      }
      .journey-step {
        position: relative;
        padding-bottom: 1.5rem;
      }
      .journey-step:last-child {
        padding-bottom: 0;
      }
      .journey-step::before {
        content: '';
        position: absolute;
        left: -1.5rem;
        top: 0.25rem;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #d0bdf4;
        border: 2px solid white;
        box-shadow: 0 0 0 2px #d0bdf4;
      }
      .journey-step.step-signup::before {
        background: #b8e3d6;
        box-shadow: 0 0 0 2px #b8e3d6;
      }
      .journey-step.step-click::before {
        background: #e8974f;
        box-shadow: 0 0 0 2px #e8974f;
      }

      /* Funnel visualization */
      .funnel-container {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0;
      }
      .funnel-stage {
        text-align: center;
        position: relative;
      }
      .funnel-bar {
        height: 80px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        margin: 0 auto;
      }
      .funnel-arrow {
        color: #ccc;
        font-size: 2rem;
        margin: 0 0.5rem;
      }
    </style>
  </head>
  <body class="bg-bg-cream text-text-main antialiased min-h-screen">
    <!-- Google Tag Manager (noscript) -->
    <noscript
      ><iframe
        src="https://www.googletagmanager.com/ns.html?id=GTM-KFK8WHV5"
        height="0"
        width="0"
        style="display: none; visibility: hidden"
      ></iframe
    ></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <!-- Password Gate -->
    <div class="password-overlay" id="passwordOverlay">
      <div class="bg-white rounded-3xl p-8 shadow-xl max-w-sm w-full mx-4">
        <div class="text-center mb-6">
          <div
            class="w-14 h-14 rounded-2xl bg-accent-purple/20 flex items-center justify-center mx-auto mb-4"
          >
            <span class="material-symbols-outlined text-primary text-2xl"
              >lock</span
            >
          </div>
          <h1 class="font-display text-2xl font-semibold text-primary mb-2">
            Campaign Dashboard
          </h1>
          <p class="text-text-muted text-sm">
            Enter password to view tracking data
          </p>
        </div>
        <form id="passwordForm">
          <input
            type="password"
            id="passwordInput"
            class="w-full px-4 py-3 rounded-full border-2 border-primary/10 focus:border-accent-purple focus:outline-none mb-4"
            placeholder="Password"
            autofocus
          />
          <p id="passwordError" class="text-accent-peach text-sm mb-4 hidden">
            Incorrect password
          </p>
          <button
            type="submit"
            class="w-full bg-primary text-white font-bold py-3 rounded-full hover:bg-primary/90 transition-colors"
          >
            Access Dashboard
          </button>
        </form>
      </div>
    </div>

    <!-- Dashboard Content -->
    <div
      class="max-w-6xl mx-auto px-6 py-12"
      id="dashboardContent"
      style="display: none"
    >
      <!-- Header -->
      <div class="flex items-center justify-between mb-8">
        <div>
          <h1 class="font-display text-3xl font-semibold text-primary mb-2">
            Campaign Tracking
          </h1>
          <p class="text-text-muted">Reddit ad performance for Chronic Life</p>
        </div>
        <button
          onclick="refreshData()"
          class="flex items-center gap-2 px-4 py-2 bg-white border border-primary/10 rounded-full hover:bg-primary-light transition-colors"
        >
          <span class="material-symbols-outlined text-lg" id="refreshIcon"
            >refresh</span
          >
          Refresh
        </button>
      </div>

      <!-- ===== EXPERIMENT RESULTS SECTION ===== -->
      <div
        class="bg-gradient-to-br from-accent-purple/10 to-accent-mint/10 rounded-3xl border border-accent-purple/20 p-8 mb-8"
      >
        <div class="flex items-center gap-3 mb-6">
          <div
            class="w-12 h-12 rounded-2xl bg-accent-purple/20 flex items-center justify-center"
          >
            <span class="material-symbols-outlined text-primary text-2xl"
              >science</span
            >
          </div>
          <div>
            <h2 class="font-display text-2xl font-semibold text-primary">
              Experiment Results
            </h2>
            <p class="text-text-muted text-sm">
              The Clarity Experiment ‚Äî $100 budget, 10 days
            </p>
          </div>
        </div>

        <!-- Winner Banner -->
        <div
          class="bg-accent-mint/30 rounded-2xl p-6 mb-6 border border-accent-mint/50"
        >
          <div class="flex items-center gap-2 mb-3">
            <span class="material-symbols-outlined text-teal-700 text-xl"
              >emoji_events</span
            >
            <span
              class="font-bold text-teal-800 uppercase text-sm tracking-wide"
              >Winner: Pattern Discovery</span
            >
          </div>
          <p class="font-display text-xl font-semibold text-primary mb-2">
            Users want to
            <span class="text-teal-700">predict flares and find triggers</span>
            ‚Äî not just track symptoms.
          </p>
          <p class="text-text-muted text-sm">
            "Predict Flares" dominated with 59 clicks at $0.05 CPC. The
            "prediction" angle resonates 4.5x better than energy-saving or
            doctor-proof messaging.
          </p>
        </div>

        <!-- Campaign Results Grid -->
        <div class="grid md:grid-cols-3 gap-4">
          <!-- Ad Group 3: Pattern Discovery - WINNER -->
          <div
            class="bg-white rounded-2xl p-5 border-2 border-accent-mint shadow-sm relative overflow-hidden"
          >
            <div
              class="absolute top-0 right-0 bg-accent-mint text-teal-900 text-xs font-bold px-3 py-1 rounded-bl-xl"
            >
              üèÜ WINNER
            </div>
            <div class="flex items-center gap-2 mb-3 mt-2">
              <span class="material-symbols-outlined text-accent-mint"
                >visibility</span
              >
              <span class="font-semibold text-primary">Pattern Discovery</span>
            </div>
            <div class="grid grid-cols-2 gap-3 mb-4">
              <div class="bg-bg-cream rounded-xl p-3 text-center">
                <p class="text-2xl font-display font-bold text-teal-700">72</p>
                <p class="text-xs text-text-muted">Clicks</p>
              </div>
              <div class="bg-bg-cream rounded-xl p-3 text-center">
                <p class="text-2xl font-display font-bold text-teal-700">
                  $0.05
                </p>
                <p class="text-xs text-text-muted">CPC</p>
              </div>
            </div>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-text-muted">predict_flares</span>
                <span class="font-semibold text-accent-mint">59 clicks</span>
              </div>
              <div class="flex justify-between">
                <span class="text-text-muted">find_triggers</span>
                <span class="font-semibold text-primary">13 clicks</span>
              </div>
            </div>
            <div class="mt-4 pt-4 border-t border-primary/10">
              <p class="text-xs text-text-muted leading-relaxed">
                <strong>AI Summary:</strong> Users strongly resonate with the
                promise of predicting flares before they happen. The "early
                warning system" angle outperformed all other messaging by 4x.
              </p>
            </div>
          </div>

          <!-- Ad Group 1: Exhaustion & Brain Fog -->
          <div class="bg-white rounded-2xl p-5 border border-primary/10">
            <div class="flex items-center gap-2 mb-3">
              <span class="material-symbols-outlined text-accent-peach"
                >battery_low</span
              >
              <span class="font-semibold text-primary"
                >Exhaustion & Brain Fog</span
              >
            </div>
            <div class="grid grid-cols-2 gap-3 mb-4">
              <div class="bg-bg-cream rounded-xl p-3 text-center">
                <p class="text-2xl font-display font-bold text-text-muted">8</p>
                <p class="text-xs text-text-muted">Clicks</p>
              </div>
              <div class="bg-bg-cream rounded-xl p-3 text-center">
                <p class="text-2xl font-display font-bold text-text-muted">
                  $0.12
                </p>
                <p class="text-xs text-text-muted">CPC</p>
              </div>
            </div>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-text-muted">spoon_saver</span>
                <span class="text-text-muted">5 clicks</span>
              </div>
              <div class="flex justify-between">
                <span class="text-text-muted">foggy_minds</span>
                <span class="text-text-muted">3 clicks</span>
              </div>
            </div>
            <div class="mt-4 pt-4 border-t border-primary/10">
              <p class="text-xs text-text-muted leading-relaxed">
                <strong>AI Summary:</strong> "Save energy" messaging didn't
                resonate. Users already know tracking is hard ‚Äî they want
                solutions, not sympathy. Pivot away from this angle.
              </p>
            </div>
          </div>

          <!-- Ad Group 2: Doctor Mistrust -->
          <div class="bg-white rounded-2xl p-5 border border-primary/10">
            <div class="flex items-center gap-2 mb-3">
              <span class="material-symbols-outlined text-accent-rose"
                >medical_information</span
              >
              <span class="font-semibold text-primary">Doctor Mistrust</span>
            </div>
            <div class="grid grid-cols-2 gap-3 mb-4">
              <div class="bg-bg-cream rounded-xl p-3 text-center">
                <p class="text-2xl font-display font-bold text-text-muted">
                  11
                </p>
                <p class="text-xs text-text-muted">Clicks</p>
              </div>
              <div class="bg-bg-cream rounded-xl p-3 text-center">
                <p class="text-2xl font-display font-bold text-text-muted">
                  $0.09
                </p>
                <p class="text-xs text-text-muted">CPC</p>
              </div>
            </div>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-text-muted">doctor_proof</span>
                <span class="text-text-muted">7 clicks</span>
              </div>
              <div class="flex justify-between">
                <span class="text-text-muted">appointment_prep</span>
                <span class="text-text-muted">4 clicks</span>
              </div>
            </div>
            <div class="mt-4 pt-4 border-t border-primary/10">
              <p class="text-xs text-text-muted leading-relaxed">
                <strong>AI Summary:</strong> Doctor-proof messaging had moderate
                interest but lacks urgency. Users want personal insight first ‚Äî
                doctor communication is a "nice to have," not primary.
              </p>
            </div>
          </div>
        </div>

        <!-- Key Insights -->
        <div class="mt-6 bg-white rounded-2xl p-5 border border-primary/10">
          <h3 class="font-semibold text-primary mb-3 flex items-center gap-2">
            <span class="material-symbols-outlined text-lg">lightbulb</span>
            Key Takeaways
          </h3>
          <div class="grid md:grid-cols-2 gap-4 text-sm">
            <div class="flex gap-3">
              <span
                class="material-symbols-outlined text-accent-mint text-lg mt-0.5"
                >check_circle</span
              >
              <div>
                <p class="font-medium text-primary">
                  Product Direction: Prediction Engine
                </p>
                <p class="text-text-muted">
                  Build flare forecasting and trigger detection as core
                  features.
                </p>
              </div>
            </div>
            <div class="flex gap-3">
              <span
                class="material-symbols-outlined text-accent-mint text-lg mt-0.5"
                >check_circle</span
              >
              <div>
                <p class="font-medium text-primary">
                  Messaging: "Know Before It Hits"
                </p>
                <p class="text-text-muted">
                  Lead with prediction/foresight, not energy savings.
                </p>
              </div>
            </div>
            <div class="flex gap-3">
              <span
                class="material-symbols-outlined text-accent-peach text-lg mt-0.5"
                >cancel</span
              >
              <div>
                <p class="font-medium text-primary">
                  Deprioritize: "Save Spoons" Angle
                </p>
                <p class="text-text-muted">
                  Energy-saving messaging underperformed significantly.
                </p>
              </div>
            </div>
            <div class="flex gap-3">
              <span
                class="material-symbols-outlined text-accent-blue text-lg mt-0.5"
                >arrow_forward</span
              >
              <div>
                <p class="font-medium text-primary">
                  Next Test: Prediction Depth
                </p>
                <p class="text-text-muted">
                  Testing: Flare Forecast vs Top Suspect vs Crash Prevention.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- ===== END EXPERIMENT RESULTS ===== -->

      <!-- ===== PREDICTION DEPTH TEST V2 SECTION ===== -->
      <div
        class="bg-gradient-to-br from-accent-blue/10 to-accent-purple/10 rounded-3xl border border-accent-blue/20 p-8 mb-8"
      >
        <div class="flex items-center gap-3 mb-6">
          <div
            class="w-12 h-12 rounded-2xl bg-accent-blue/20 flex items-center justify-center"
          >
            <span class="material-symbols-outlined text-primary text-2xl"
              >labs</span
            >
          </div>
          <div>
            <h2 class="font-display text-2xl font-semibold text-primary">
              Prediction Depth Test v2
            </h2>
            <p class="text-text-muted text-sm">
              Testing: Time vs Variable vs Action ‚Äî Live Campaign
            </p>
          </div>
        </div>

        <!-- Product Offering Performance Grid -->
        <div class="grid md:grid-cols-4 gap-4 mb-6">
          <!-- Flare Forecast -->
          <div
            class="bg-white rounded-2xl p-5 border border-accent-purple/20 hover:shadow-lg transition-shadow"
          >
            <div class="flex items-center gap-2 mb-3">
              <span class="material-symbols-outlined text-accent-purple"
                >cloud</span
              >
              <span class="font-semibold text-primary text-sm"
                >Flare Forecast</span
              >
            </div>
            <div class="space-y-2">
              <div class="flex justify-between text-sm">
                <span class="text-text-muted">Visits</span>
                <span class="font-semibold text-primary" id="pdv2FlareVisits"
                  >-</span
                >
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-text-muted">Modal Opens</span>
                <span class="font-semibold text-primary" id="pdv2FlareModals"
                  >-</span
                >
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-text-muted">Completes</span>
                <span
                  class="font-semibold text-accent-mint"
                  id="pdv2FlareCompletes"
                  >-</span
                >
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-text-muted">Signups</span>
                <span class="font-semibold text-teal-700" id="pdv2FlareSignups"
                  >-</span
                >
              </div>
            </div>
          </div>

          <!-- Top Suspect -->
          <div
            class="bg-white rounded-2xl p-5 border border-accent-peach/20 hover:shadow-lg transition-shadow"
          >
            <div class="flex items-center gap-2 mb-3">
              <span class="material-symbols-outlined text-accent-peach"
                >search</span
              >
              <span class="font-semibold text-primary text-sm"
                >Top Suspect</span
              >
            </div>
            <div class="space-y-2">
              <div class="flex justify-between text-sm">
                <span class="text-text-muted">Visits</span>
                <span class="font-semibold text-primary" id="pdv2SuspectVisits"
                  >-</span
                >
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-text-muted">Modal Opens</span>
                <span class="font-semibold text-primary" id="pdv2SuspectModals"
                  >-</span
                >
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-text-muted">Completes</span>
                <span
                  class="font-semibold text-accent-mint"
                  id="pdv2SuspectCompletes"
                  >-</span
                >
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-text-muted">Signups</span>
                <span
                  class="font-semibold text-teal-700"
                  id="pdv2SuspectSignups"
                  >-</span
                >
              </div>
            </div>
          </div>

          <!-- Crash Prevention -->
          <div
            class="bg-white rounded-2xl p-5 border border-accent-mint/30 hover:shadow-lg transition-shadow"
          >
            <div class="flex items-center gap-2 mb-3">
              <span class="material-symbols-outlined text-teal-600"
                >battery_horiz_075</span
              >
              <span class="font-semibold text-primary text-sm"
                >Crash Prevention</span
              >
            </div>
            <div class="space-y-2">
              <div class="flex justify-between text-sm">
                <span class="text-text-muted">Visits</span>
                <span class="font-semibold text-primary" id="pdv2PreventVisits"
                  >-</span
                >
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-text-muted">Modal Opens</span>
                <span class="font-semibold text-primary" id="pdv2PreventModals"
                  >-</span
                >
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-text-muted">Completes</span>
                <span
                  class="font-semibold text-accent-mint"
                  id="pdv2PreventCompletes"
                  >-</span
                >
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-text-muted">Signups</span>
                <span
                  class="font-semibold text-teal-700"
                  id="pdv2PreventSignups"
                  >-</span
                >
              </div>
            </div>
          </div>

          <!-- Spoon Saver -->
          <div
            class="bg-white rounded-2xl p-5 border border-accent-blue/20 hover:shadow-lg transition-shadow"
          >
            <div class="flex items-center gap-2 mb-3">
              <span class="material-symbols-outlined text-accent-blue"
                >bolt</span
              >
              <span class="font-semibold text-primary text-sm"
                >Spoon Saver</span
              >
            </div>
            <div class="space-y-2">
              <div class="flex justify-between text-sm">
                <span class="text-text-muted">Visits</span>
                <span class="font-semibold text-primary" id="pdv2SpoonVisits"
                  >-</span
                >
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-text-muted">Modal Opens</span>
                <span class="font-semibold text-primary" id="pdv2SpoonModals"
                  >-</span
                >
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-text-muted">Completes</span>
                <span
                  class="font-semibold text-accent-mint"
                  id="pdv2SpoonCompletes"
                  >-</span
                >
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-text-muted">Signups</span>
                <span class="font-semibold text-teal-700" id="pdv2SpoonSignups"
                  >-</span
                >
              </div>
            </div>
          </div>
        </div>

        <!-- Modal Question Responses -->
        <div class="bg-white rounded-2xl p-5 border border-primary/10">
          <h3 class="font-semibold text-primary mb-4 flex items-center gap-2">
            <span class="material-symbols-outlined text-lg">ballot</span>
            Modal Response Distribution
          </h3>
          <div class="grid md:grid-cols-3 gap-6">
            <!-- Condition Distribution -->
            <div>
              <p class="text-sm font-semibold text-text-muted mb-3">
                Primary Condition
              </p>
              <div class="space-y-2" id="conditionDistribution">
                <p class="text-text-muted text-xs">Loading...</p>
              </div>
            </div>
            <!-- Tracking Status -->
            <div>
              <p class="text-sm font-semibold text-text-muted mb-3">
                Current Tracking
              </p>
              <div class="space-y-2" id="trackingDistribution">
                <p class="text-text-muted text-xs">Loading...</p>
              </div>
            </div>
            <!-- Energy Level -->
            <div>
              <p class="text-sm font-semibold text-text-muted mb-3">
                Energy Today
              </p>
              <div class="space-y-2" id="energyDistribution">
                <p class="text-text-muted text-xs">Loading...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Persona Performance -->
        <div class="mt-6 bg-white rounded-2xl p-5 border border-primary/10">
          <h3 class="font-semibold text-primary mb-4 flex items-center gap-2">
            <span class="material-symbols-outlined text-lg">group</span>
            Persona A/B Test Results
          </h3>
          <div class="grid md:grid-cols-3 gap-4">
            <div class="bg-bg-cream rounded-xl p-4 text-center">
              <p class="font-semibold text-primary">Maya</p>
              <p
                class="text-2xl font-display font-bold text-accent-purple mt-1"
                id="personaMayaRate"
              >
                -
              </p>
              <p class="text-xs text-text-muted">conversion rate</p>
            </div>
            <div class="bg-bg-cream rounded-xl p-4 text-center">
              <p class="font-semibold text-primary">Jordan</p>
              <p
                class="text-2xl font-display font-bold text-accent-peach mt-1"
                id="personaJordanRate"
              >
                -
              </p>
              <p class="text-xs text-text-muted">conversion rate</p>
            </div>
            <div class="bg-bg-cream rounded-xl p-4 text-center">
              <p class="font-semibold text-primary">Marcus</p>
              <p
                class="text-2xl font-display font-bold text-accent-mint mt-1"
                id="personaMarcusRate"
              >
                -
              </p>
              <p class="text-xs text-text-muted">conversion rate</p>
            </div>
          </div>
        </div>
      </div>
      <!-- ===== END PREDICTION DEPTH TEST V2 ===== -->

      <!-- Conversion Funnel Visualization -->
      <div class="bg-white rounded-3xl border border-primary/5 p-6 mb-8">
        <div class="flex items-center gap-3 mb-6">
          <div
            class="w-10 h-10 rounded-xl bg-accent-purple/20 flex items-center justify-center"
          >
            <span class="material-symbols-outlined text-primary"
              >filter_alt</span
            >
          </div>
          <div>
            <h2 class="font-display text-xl font-semibold text-primary">
              Conversion Funnel
            </h2>
            <p class="text-text-muted text-sm">
              Track visitors through to Beta signup
            </p>
          </div>
        </div>

        <div class="funnel-container">
          <!-- Stage 1: Page Views -->
          <div class="funnel-stage flex-1">
            <div class="funnel-bar bg-accent-purple/20" style="width: 100%">
              <div class="text-center">
                <p
                  class="font-display text-2xl font-bold text-primary"
                  id="funnelViews"
                >
                  -
                </p>
                <p class="text-xs text-text-muted">Page Views</p>
              </div>
            </div>
            <p class="text-xs text-text-muted mt-2" id="funnelViewsSessions">
              - unique sessions
            </p>
          </div>

          <div class="funnel-arrow">‚Üí</div>

          <!-- Stage 2: CTA Clicks -->
          <div class="funnel-stage flex-1">
            <div
              class="funnel-bar bg-accent-peach/30"
              id="funnelClicksBar"
              style="width: 80%"
            >
              <div class="text-center">
                <p
                  class="font-display text-2xl font-bold text-primary"
                  id="funnelClicks"
                >
                  -
                </p>
                <p class="text-xs text-text-muted">CTA Clicks</p>
              </div>
            </div>
            <p class="text-xs text-text-muted mt-2">
              <span id="funnelClickRate">-</span> click rate
            </p>
          </div>

          <div class="funnel-arrow">‚Üí</div>

          <!-- Stage 3: Signups (Final CTA) -->
          <div class="funnel-stage flex-1">
            <div
              class="funnel-bar bg-accent-mint/40"
              id="funnelSignupsBar"
              style="width: 60%"
            >
              <div class="text-center">
                <p
                  class="font-display text-2xl font-bold text-teal-700"
                  id="funnelSignups"
                >
                  -
                </p>
                <p class="text-xs text-text-muted">Beta Signups</p>
              </div>
            </div>
            <p class="text-xs text-accent-mint font-semibold mt-2">
              <span id="funnelConvRate">-</span> of clickers
            </p>
          </div>
        </div>

        <!-- Funnel insights -->
        <div
          class="mt-6 pt-4 border-t border-primary/5 grid grid-cols-3 gap-4 text-center"
        >
          <div>
            <p
              class="text-2xl font-display font-bold text-primary"
              id="funnelOverallConv"
            >
              -
            </p>
            <p class="text-xs text-text-muted">Overall Conversion</p>
          </div>
          <div>
            <p
              class="text-2xl font-display font-bold text-accent-peach"
              id="funnelAvgClicks"
            >
              -
            </p>
            <p class="text-xs text-text-muted">Avg clicks before signup</p>
          </div>
          <div>
            <p
              class="text-2xl font-display font-bold text-accent-purple"
              id="funnelTimeToConv"
            >
              -
            </p>
            <p class="text-xs text-text-muted">Avg time to signup</p>
          </div>
        </div>
      </div>

      <!-- Summary Cards -->
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">
        <div class="bg-white rounded-2xl p-6 border border-primary/5">
          <p class="text-text-muted text-sm mb-1">Total Views</p>
          <p
            class="font-display text-3xl font-bold text-primary"
            id="totalViews"
          >
            -
          </p>
        </div>
        <div class="bg-white rounded-2xl p-6 border border-primary/5">
          <p class="text-text-muted text-sm mb-1">CTA Clicks</p>
          <p
            class="font-display text-3xl font-bold text-primary"
            id="totalClicks"
          >
            -
          </p>
        </div>
        <div class="bg-white rounded-2xl p-6 border border-primary/5">
          <p class="text-text-muted text-sm mb-1">Signups</p>
          <p
            class="font-display text-3xl font-bold text-accent-mint"
            id="totalSignups"
          >
            -
          </p>
        </div>
        <div class="bg-white rounded-2xl p-6 border border-primary/5">
          <p class="text-text-muted text-sm mb-1">Conversion Rate</p>
          <p
            class="font-display text-3xl font-bold text-accent-peach"
            id="conversionRate"
          >
            -
          </p>
        </div>
        <div class="bg-white rounded-2xl p-6 border border-primary/5">
          <p class="text-text-muted text-sm mb-1">Null Referrer</p>
          <p
            class="font-display text-3xl font-bold text-accent-blue"
            id="nullReferrer"
          >
            -
          </p>
        </div>
        <div class="bg-white rounded-2xl p-6 border border-primary/5">
          <p class="text-text-muted text-sm mb-1">Other Referrer</p>
          <p
            class="font-display text-3xl font-bold text-accent-purple"
            id="otherReferrer"
          >
            -
          </p>
        </div>
      </div>

      <!-- Campaign Table -->
      <div
        class="bg-white rounded-3xl border border-primary/5 overflow-hidden mb-8"
      >
        <div class="px-6 py-4 border-b border-primary/5">
          <h2 class="font-display text-xl font-semibold text-primary">
            Campaign Performance
          </h2>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-bg-cream">
              <tr>
                <th
                  class="px-6 py-3 text-left text-sm font-semibold text-text-muted"
                >
                  Campaign
                </th>
                <th
                  class="px-6 py-3 text-left text-sm font-semibold text-text-muted"
                >
                  Content
                </th>
                <th
                  class="px-6 py-3 text-right text-sm font-semibold text-text-muted"
                >
                  Views
                </th>
                <th
                  class="px-6 py-3 text-right text-sm font-semibold text-text-muted"
                >
                  Clicks
                </th>
                <th
                  class="px-6 py-3 text-right text-sm font-semibold text-text-muted"
                >
                  Signups
                </th>
                <th
                  class="px-6 py-3 text-right text-sm font-semibold text-text-muted"
                >
                  Click Rate
                </th>
                <th
                  class="px-6 py-3 text-right text-sm font-semibold text-text-muted"
                >
                  Conv Rate
                </th>
                <th
                  class="px-6 py-3 text-right text-sm font-semibold text-text-muted"
                >
                  Null Referrer
                </th>
                <th
                  class="px-6 py-3 text-right text-sm font-semibold text-text-muted"
                >
                  Other Referrer
                </th>
              </tr>
            </thead>
            <tbody id="campaignTable">
              <tr>
                <td colspan="9" class="px-6 py-8 text-center text-text-muted">
                  <span class="material-symbols-outlined animate-spin"
                    >progress_activity</span
                  >
                  <p class="mt-2">Loading data...</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- CTA Clicks by Page -->
      <div
        class="bg-white rounded-3xl border border-primary/5 overflow-hidden mb-8"
      >
        <div class="px-6 py-4 border-b border-primary/5">
          <h2 class="font-display text-xl font-semibold text-primary">
            CTA Clicks by Page
          </h2>
          <p class="text-text-muted text-sm mt-1">
            Which buttons are getting clicks on each landing page
          </p>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-bg-cream">
              <tr>
                <th
                  class="px-6 py-3 text-left text-sm font-semibold text-text-muted"
                >
                  Page
                </th>
                <th
                  class="px-6 py-3 text-left text-sm font-semibold text-text-muted"
                >
                  CTA Button
                </th>
                <th
                  class="px-6 py-3 text-left text-sm font-semibold text-text-muted"
                >
                  Element ID
                </th>
                <th
                  class="px-6 py-3 text-right text-sm font-semibold text-text-muted"
                >
                  Clicks
                </th>
                <th
                  class="px-6 py-3 text-right text-sm font-semibold text-text-muted"
                >
                  % of Total
                </th>
              </tr>
            </thead>
            <tbody id="ctaClicksTable">
              <tr>
                <td colspan="5" class="px-6 py-8 text-center text-text-muted">
                  <span class="material-symbols-outlined animate-spin"
                    >progress_activity</span
                  >
                  <p class="mt-2">Loading data...</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Recent Signups -->
      <div class="bg-white rounded-3xl border border-primary/5 overflow-hidden">
        <div
          class="px-6 py-4 border-b border-primary/5 flex items-center justify-between"
        >
          <div>
            <h2 class="font-display text-xl font-semibold text-primary">
              Recent Signups
            </h2>
            <p class="text-text-muted text-sm mt-1">
              Click on a user to view their complete journey
            </p>
          </div>
          <div class="flex items-center gap-2 text-accent-mint">
            <span class="material-symbols-outlined text-lg">celebration</span>
            <span class="font-semibold" id="signupCount">0</span>
            <span class="text-text-muted text-sm">total</span>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-bg-cream">
              <tr>
                <th
                  class="px-6 py-3 text-left text-sm font-semibold text-text-muted"
                >
                  Email
                </th>
                <th
                  class="px-6 py-3 text-left text-sm font-semibold text-text-muted"
                >
                  Campaign
                </th>
                <th
                  class="px-6 py-3 text-left text-sm font-semibold text-text-muted"
                >
                  Content
                </th>
                <th
                  class="px-6 py-3 text-left text-sm font-semibold text-text-muted"
                >
                  Source
                </th>
                <th
                  class="px-6 py-3 text-left text-sm font-semibold text-text-muted"
                >
                  Date
                </th>
                <th
                  class="px-6 py-3 text-right text-sm font-semibold text-text-muted"
                >
                  Journey
                </th>
              </tr>
            </thead>
            <tbody id="signupsTable">
              <tr>
                <td colspan="6" class="px-6 py-8 text-center text-text-muted">
                  <span class="material-symbols-outlined animate-spin"
                    >progress_activity</span
                  >
                  <p class="mt-2">Loading data...</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Footer -->
      <div class="text-center mt-8 text-text-muted text-sm">
        <p>Last updated: <span id="lastUpdated">-</span></p>
      </div>
    </div>

    <!-- Referrer Details Modal -->
    <div class="referrer-modal hidden" id="referrerModal">
      <div class="referrer-modal-content">
        <div
          class="px-6 py-4 border-b border-primary/5 flex items-center justify-between"
        >
          <div>
            <h2
              class="font-display text-xl font-semibold text-primary"
              id="modalTitle"
            >
              Referrer Breakdown
            </h2>
            <p class="text-text-muted text-sm mt-1" id="modalSubtitle">-</p>
          </div>
          <button
            onclick="closeReferrerModal()"
            class="p-2 hover:bg-primary-light rounded-full transition-colors"
          >
            <span class="material-symbols-outlined text-primary">close</span>
          </button>
        </div>
        <div class="overflow-y-auto flex-1 px-6 py-4">
          <div id="referrerBreakdown">
            <p class="text-text-muted text-center py-8">Loading...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- User Journey Modal -->
    <div class="user-modal hidden" id="userModal">
      <div class="user-modal-content">
        <div
          class="px-6 py-4 border-b border-primary/5 flex items-center justify-between bg-gradient-to-r from-accent-purple/10 to-accent-mint/10"
        >
          <div>
            <h2
              class="font-display text-xl font-semibold text-primary"
              id="userModalTitle"
            >
              User Journey
            </h2>
            <p class="text-text-muted text-sm mt-1" id="userModalEmail">-</p>
          </div>
          <button
            onclick="closeUserModal()"
            class="p-2 hover:bg-primary-light rounded-full transition-colors"
          >
            <span class="material-symbols-outlined text-primary">close</span>
          </button>
        </div>

        <!-- User summary stats -->
        <div class="px-6 py-4 border-b border-primary/5 bg-bg-cream">
          <div class="grid grid-cols-4 gap-4">
            <div class="text-center">
              <p
                class="font-display text-xl font-bold text-primary"
                id="userStatsEvents"
              >
                -
              </p>
              <p class="text-xs text-text-muted">Total Events</p>
            </div>
            <div class="text-center">
              <p
                class="font-display text-xl font-bold text-accent-peach"
                id="userStatsClicks"
              >
                -
              </p>
              <p class="text-xs text-text-muted">CTA Clicks</p>
            </div>
            <div class="text-center">
              <p
                class="font-display text-xl font-bold text-accent-purple"
                id="userStatsTime"
              >
                -
              </p>
              <p class="text-xs text-text-muted">Time to Signup</p>
            </div>
            <div class="text-center">
              <p
                class="font-display text-xl font-bold text-accent-mint"
                id="userStatsSource"
              >
                -
              </p>
              <p class="text-xs text-text-muted">Source</p>
            </div>
          </div>
        </div>

        <!-- Journey timeline -->
        <div class="overflow-y-auto flex-1 px-6 py-6">
          <h3 class="font-semibold text-primary mb-4 flex items-center gap-2">
            <span class="material-symbols-outlined text-lg">timeline</span>
            Complete Journey
          </h3>
          <div class="journey-timeline" id="userJourneyTimeline">
            <p class="text-text-muted text-center py-8">Loading journey...</p>
          </div>
        </div>

        <!-- Attribution details -->
        <div class="px-6 py-4 border-t border-primary/5 bg-bg-cream">
          <h4 class="font-semibold text-primary text-sm mb-2">Attribution</h4>
          <div class="grid grid-cols-2 gap-2 text-xs">
            <div>
              <span class="text-text-muted">Campaign:</span>
              <span class="font-medium" id="userAttrCampaign">-</span>
            </div>
            <div>
              <span class="text-text-muted">Content:</span>
              <span class="font-medium" id="userAttrContent">-</span>
            </div>
            <div>
              <span class="text-text-muted">Landing URL:</span>
              <span class="font-medium truncate block" id="userAttrUrl">-</span>
            </div>
            <div>
              <span class="text-text-muted">Device:</span>
              <span class="font-medium" id="userAttrDevice">-</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ===== CONFIG =====
      const SUPABASE_URL = 'https://zvpudxinbcsrfyojrhhv.supabase.co';
      const SUPABASE_ANON_KEY =
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp2cHVkeGluYmNzcmZ5b2pyaGh2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5NTE3MjksImV4cCI6MjA4MjUyNzcyOX0.5vV65qusPzu7847VxbiodRU0DZG1AryUuoklX3qFAWk';
      const DASHBOARD_PASSWORD = 'chroniclife2025';

      const supabaseClient = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY
      );

      // Store events and signups globally for referrer breakdown
      let allEvents = [];
      let allSignups = [];

      // ===== PASSWORD GATE =====
      const passwordOverlay = document.getElementById('passwordOverlay');
      const passwordForm = document.getElementById('passwordForm');
      const passwordInput = document.getElementById('passwordInput');
      const passwordError = document.getElementById('passwordError');
      const dashboardContent = document.getElementById('dashboardContent');

      // Check if already authenticated
      if (sessionStorage.getItem('dashboard_auth') === 'true') {
        passwordOverlay.classList.add('hidden');
        dashboardContent.style.display = 'block';
        loadDashboardData();
      }

      passwordForm.addEventListener('submit', function (e) {
        e.preventDefault();
        if (passwordInput.value === DASHBOARD_PASSWORD) {
          sessionStorage.setItem('dashboard_auth', 'true');
          passwordOverlay.classList.add('hidden');
          dashboardContent.style.display = 'block';
          loadDashboardData();
        } else {
          passwordError.classList.remove('hidden');
          passwordInput.classList.add('border-accent-peach');
        }
      });

      // ===== DATA LOADING =====
      async function loadDashboardData() {
        try {
          // Fetch events
          const { data: events, error: eventsError } = await supabaseClient
            .from('marketing_events')
            .select('*')
            .order('created_at', { ascending: false });

          // Fetch signups
          const { data: signups, error: signupsError } = await supabaseClient
            .from('beta_signups')
            .select('*')
            .order('created_at', { ascending: false });

          // Fetch new campaign tables for Prediction Depth Test v2
          const { data: landingVisits } = await supabaseClient
            .from('landing_visits')
            .select('*')
            .order('created_at', { ascending: false });

          const { data: modalSessions } = await supabaseClient
            .from('modal_sessions')
            .select('*')
            .order('created_at', { ascending: false });

          const { data: modalResponses } = await supabaseClient
            .from('modal_responses')
            .select('*')
            .order('created_at', { ascending: false });

          if (eventsError) throw eventsError;
          if (signupsError) throw signupsError;

          // Store globally for referrer breakdown
          allEvents = events || [];
          allSignups = signups || [];

          renderDashboard(allEvents, allSignups);

          // Render Prediction Depth Test v2 section
          renderPredictionDepthTest(
            landingVisits || [],
            modalSessions || [],
            modalResponses || [],
            signups || []
          );

          document.getElementById('lastUpdated').textContent =
            new Date().toISOString().replace('T', ' ').slice(0, 19) + ' UTC';
        } catch (err) {
          console.error('Error loading data:', err);
          document.getElementById('campaignTable').innerHTML = `
          <tr>
            <td colspan="9" class="px-6 py-8 text-center text-accent-peach">
              Error loading data. Check console for details.
            </td>
          </tr>
        `;
        }
      }

      // ===== PREDICTION DEPTH TEST V2 RENDERING =====
      function renderPredictionDepthTest(visits, sessions, responses, signups) {
        const products = [
          'flare-forecast',
          'top-suspect',
          'crash-prevention',
          'spoon-saver',
        ];
        const productMap = {
          'flare-forecast': 'Flare',
          'top-suspect': 'Suspect',
          'crash-prevention': 'Prevent',
          'spoon-saver': 'Spoon',
        };

        // Calculate metrics per product
        products.forEach((product) => {
          const productVisits = visits.filter(
            (v) => v.product_offering === product
          );
          const productSessions = sessions.filter(
            (s) => s.product_offering === product
          );
          const productCompletes = productSessions.filter((s) => s.completed);

          // Filter signups by UTM content that matches the product
          const productSignups = signups.filter((s) => {
            const utmContent = s.utm_content || '';
            return utmContent.includes(
              product.replace('-', '_').replace('flare-forecast', 'forecast')
            );
          });

          const prefix = `pdv2${productMap[product]}`;
          const visitsEl = document.getElementById(`${prefix}Visits`);
          const modalsEl = document.getElementById(`${prefix}Modals`);
          const completesEl = document.getElementById(`${prefix}Completes`);
          const signupsEl = document.getElementById(`${prefix}Signups`);

          if (visitsEl) visitsEl.textContent = productVisits.length;
          if (modalsEl) modalsEl.textContent = productSessions.length;
          if (completesEl) completesEl.textContent = productCompletes.length;
          if (signupsEl) signupsEl.textContent = productSignups.length;
        });

        // Render question distributions
        renderQuestionDistribution(
          'q1_condition',
          'conditionDistribution',
          responses
        );
        renderQuestionDistribution(
          'q2_tracking',
          'trackingDistribution',
          responses
        );
        renderQuestionDistribution(
          'q3_energy',
          'energyDistribution',
          responses
        );

        // Calculate persona conversion rates
        const personas = ['maya', 'jordan', 'marcus'];
        personas.forEach((persona) => {
          const personaVisits = visits.filter(
            (v) => v.persona_shown === persona
          );
          const personaSessions = sessions.filter(
            (s) => s.persona_shown === persona
          );
          const personaCompletes = personaSessions.filter((s) => s.completed);

          const rate =
            personaSessions.length > 0
              ? (
                  (personaCompletes.length / personaSessions.length) *
                  100
                ).toFixed(1) + '%'
              : '-';

          const el = document.getElementById(
            `persona${persona.charAt(0).toUpperCase() + persona.slice(1)}Rate`
          );
          if (el) el.textContent = rate;
        });
      }

      function renderQuestionDistribution(questionKey, containerId, responses) {
        const container = document.getElementById(containerId);
        if (!container) return;

        const questionResponses = responses.filter(
          (r) => r.question_key === questionKey
        );
        if (questionResponses.length === 0) {
          container.innerHTML =
            '<p class="text-text-muted text-xs">No responses yet</p>';
          return;
        }

        // Count answers
        const counts = {};
        questionResponses.forEach((r) => {
          const label = r.answer_label || r.answer_value;
          counts[label] = (counts[label] || 0) + 1;
        });

        // Sort by count
        const sorted = Object.entries(counts)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 5); // Top 5

        const total = questionResponses.length;
        const colors = [
          'bg-accent-purple',
          'bg-accent-peach',
          'bg-accent-mint',
          'bg-accent-blue',
          'bg-accent-rose',
        ];

        container.innerHTML = sorted
          .map(([label, count], i) => {
            const pct = ((count / total) * 100).toFixed(0);
            const color = colors[i % colors.length];
            return `
            <div class="flex items-center gap-2">
              <div class="w-16 h-2 bg-bg-cream rounded-full overflow-hidden">
                <div class="${color}/60 h-full rounded-full" style="width: ${pct}%"></div>
              </div>
              <span class="text-xs text-text-muted flex-1 truncate">${label}</span>
              <span class="text-xs font-semibold text-primary">${count}</span>
            </div>
          `;
          })
          .join('');
      }

      function renderDashboard(events, signups) {
        // Calculate totals
        const pageViews = events.filter((e) => e.event_type === 'page_view');
        const clicks = events.filter((e) => e.event_type === 'cta_click');

        document.getElementById('totalViews').textContent = pageViews.length;
        document.getElementById('totalClicks').textContent = clicks.length;
        document.getElementById('totalSignups').textContent = signups.length;
        document.getElementById('signupCount').textContent = signups.length;

        // Render funnel visualization
        renderFunnel(events, signups);

        // Render CTA clicks breakdown
        renderCtaClicksTable(clicks);

        const convRate =
          clicks.length > 0
            ? ((signups.length / clicks.length) * 100).toFixed(1) + '%'
            : '0%';
        document.getElementById('conversionRate').textContent = convRate;

        // Calculate referrer counts
        const allReferrers = [
          ...events.map((e) => e.referrer),
          ...signups.map((s) => s.referrer),
        ];
        const nullReferrerCount = allReferrers.filter(
          (r) => !r || r === null || r === ''
        ).length;
        const otherReferrerCount = allReferrers.filter(
          (r) => r && r !== null && r !== ''
        ).length;

        document.getElementById('nullReferrer').textContent = nullReferrerCount;
        document.getElementById('otherReferrer').textContent =
          otherReferrerCount;

        // Group by campaign + content
        const campaigns = {};

        // Process page views
        pageViews.forEach((e) => {
          const key = `${e.utm_campaign || 'direct'}|${e.utm_content || 'none'}`;
          if (!campaigns[key]) {
            campaigns[key] = {
              campaign: e.utm_campaign || 'Direct',
              content: e.utm_content || '-',
              views: 0,
              clicks: 0,
              signups: 0,
              nullReferrer: 0,
              otherReferrer: 0,
            };
          }
          campaigns[key].views++;
          // Count referrer for this event
          if (!e.referrer || e.referrer === null || e.referrer === '') {
            campaigns[key].nullReferrer++;
          } else {
            campaigns[key].otherReferrer++;
          }
        });

        // Process clicks
        clicks.forEach((e) => {
          const key = `${e.utm_campaign || 'direct'}|${e.utm_content || 'none'}`;
          if (!campaigns[key]) {
            campaigns[key] = {
              campaign: e.utm_campaign || 'Direct',
              content: e.utm_content || '-',
              views: 0,
              clicks: 0,
              signups: 0,
              nullReferrer: 0,
              otherReferrer: 0,
            };
          }
          campaigns[key].clicks++;
          // Count referrer for this event
          if (!e.referrer || e.referrer === null || e.referrer === '') {
            campaigns[key].nullReferrer++;
          } else {
            campaigns[key].otherReferrer++;
          }
        });

        // Process signups
        signups.forEach((s) => {
          const key = `${s.utm_campaign || 'direct'}|${s.utm_content || 'none'}`;
          if (!campaigns[key]) {
            campaigns[key] = {
              campaign: s.utm_campaign || 'Direct',
              content: s.utm_content || '-',
              views: 0,
              clicks: 0,
              signups: 0,
              nullReferrer: 0,
              otherReferrer: 0,
            };
          }
          campaigns[key].signups++;
          // Count referrer for this signup
          if (!s.referrer || s.referrer === null || s.referrer === '') {
            campaigns[key].nullReferrer++;
          } else {
            campaigns[key].otherReferrer++;
          }
        });

        // Render campaign table
        const campaignData = Object.values(campaigns).sort(
          (a, b) => b.signups - a.signups
        );

        if (campaignData.length === 0) {
          document.getElementById('campaignTable').innerHTML = `
          <tr>
            <td colspan="9" class="px-6 py-8 text-center text-text-muted">
              No data yet. Run some ads!
            </td>
          </tr>
        `;
        } else {
          document.getElementById('campaignTable').innerHTML = campaignData
            .map((c) => {
              const clickRate =
                c.views > 0 ? ((c.clicks / c.views) * 100).toFixed(1) : 0;
              const convRate =
                c.clicks > 0 ? ((c.signups / c.clicks) * 100).toFixed(1) : 0;

              const clickRateClass =
                clickRate >= 15
                  ? 'metric-good'
                  : clickRate >= 5
                    ? 'metric-okay'
                    : 'metric-bad';
              const convRateClass =
                convRate >= 10
                  ? 'metric-good'
                  : convRate >= 3
                    ? 'metric-okay'
                    : 'metric-bad';

              const rowKey = `${c.campaign}|${c.content}`;
              // Encode for HTML attributes (escape quotes)
              const campaignData = (c.campaign || 'Direct').replace(
                /"/g,
                '&quot;'
              );
              const contentData = (c.content || '-').replace(/"/g, '&quot;');
              return `
            <tr class="border-b border-primary/5 campaign-row-clickable"
                data-campaign="${campaignData}"
                data-content="${contentData}">
              <td class="px-6 py-4 font-medium text-primary">${escapeHtml(c.campaign)}</td>
              <td class="px-6 py-4 text-text-muted">${escapeHtml(c.content)}</td>
              <td class="px-6 py-4 text-right">${c.views}</td>
              <td class="px-6 py-4 text-right">${c.clicks}</td>
              <td class="px-6 py-4 text-right font-semibold">${c.signups}</td>
              <td class="px-6 py-4 text-right ${clickRateClass}">${clickRate}%</td>
              <td class="px-6 py-4 text-right ${convRateClass}">${convRate}%</td>
              <td class="px-6 py-4 text-right text-accent-blue">${c.nullReferrer}</td>
              <td class="px-6 py-4 text-right text-accent-purple">${c.otherReferrer}</td>
            </tr>
          `;
            })
            .join('');

          // Add click handlers to campaign rows
          document
            .querySelectorAll('.campaign-row-clickable')
            .forEach((row) => {
              row.addEventListener('click', function () {
                const campaign = this.dataset.campaign;
                const content = this.dataset.content;
                showReferrerBreakdown(campaign, content);
              });
            });
        }

        // Render signups table (last 20)
        const recentSignups = signups.slice(0, 20);

        if (recentSignups.length === 0) {
          document.getElementById('signupsTable').innerHTML = `
          <tr>
            <td colspan="6" class="px-6 py-8 text-center text-text-muted">
              No signups yet. Keep pushing!
            </td>
          </tr>
        `;
        } else {
          document.getElementById('signupsTable').innerHTML = recentSignups
            .map((s) => {
              const date = formatUTCDate(s.created_at);
              const emailEncoded = (s.email || '').replace(/"/g, '&quot;');
              return `
            <tr class="border-b border-primary/5 user-row-clickable"
                data-email="${emailEncoded}"
                onclick="showUserJourney('${emailEncoded}')">
              <td class="px-6 py-4">
                <div class="flex items-center gap-2">
                  <div class="w-8 h-8 rounded-full bg-accent-purple/20 flex items-center justify-center text-sm font-semibold text-primary">
                    ${(s.email || '?')[0].toUpperCase()}
                  </div>
                  <span class="font-medium text-primary">${escapeHtml(s.email)}</span>
                </div>
              </td>
              <td class="px-6 py-4">${escapeHtml(s.utm_campaign || 'Direct')}</td>
              <td class="px-6 py-4 text-text-muted">${escapeHtml(s.utm_content || '-')}</td>
              <td class="px-6 py-4 text-text-muted">${escapeHtml(s.utm_source || 'Direct')}</td>
              <td class="px-6 py-4 text-text-muted">${date}</td>
              <td class="px-6 py-4 text-right">
                <span class="inline-flex items-center gap-1 text-accent-purple text-sm font-medium">
                  View <span class="material-symbols-outlined text-base">arrow_forward</span>
                </span>
              </td>
            </tr>
          `;
            })
            .join('');
        }
      }

      function refreshData() {
        const icon = document.getElementById('refreshIcon');
        icon.classList.add('animate-spin');
        loadDashboardData().then(() => {
          setTimeout(() => icon.classList.remove('animate-spin'), 500);
        });
      }

      function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // ===== CTA CLICKS BREAKDOWN =====
      function renderCtaClicksTable(clicks) {
        const totalClicks = clicks.length;

        if (totalClicks === 0) {
          document.getElementById('ctaClicksTable').innerHTML = `
          <tr>
            <td colspan="5" class="px-6 py-8 text-center text-text-muted">
              No CTA clicks recorded yet.
            </td>
          </tr>
        `;
          return;
        }

        // Group clicks by page + element
        const ctaGroups = {};

        clicks.forEach((click) => {
          // Extract page name from URL
          const pageName = extractPageName(click.page_url);
          const elementId = click.element_id || 'unknown';
          const elementText =
            cleanElementText(click.element_text) || 'Unknown Button';

          const key = `${pageName}|${elementId}|${elementText}`;

          if (!ctaGroups[key]) {
            ctaGroups[key] = {
              page: pageName,
              elementId: elementId,
              elementText: elementText,
              clicks: 0,
            };
          }
          ctaGroups[key].clicks++;
        });

        // Sort by clicks descending
        const sortedGroups = Object.values(ctaGroups).sort(
          (a, b) => b.clicks - a.clicks
        );

        // Render table
        document.getElementById('ctaClicksTable').innerHTML = sortedGroups
          .map((g) => {
            const percentage = ((g.clicks / totalClicks) * 100).toFixed(1);
            const percentClass =
              percentage >= 20
                ? 'metric-good'
                : percentage >= 10
                  ? 'metric-okay'
                  : '';

            // Color code by page
            const pageColor = getPageColor(g.page);

            return `
          <tr class="border-b border-primary/5 hover:bg-bg-cream/50">
            <td class="px-6 py-4">
              <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${pageColor}">
                ${escapeHtml(g.page)}
              </span>
            </td>
            <td class="px-6 py-4 font-medium text-primary">${escapeHtml(g.elementText)}</td>
            <td class="px-6 py-4 text-text-muted font-mono text-sm">${escapeHtml(g.elementId)}</td>
            <td class="px-6 py-4 text-right font-semibold text-primary">${g.clicks}</td>
            <td class="px-6 py-4 text-right ${percentClass}">${percentage}%</td>
          </tr>
        `;
          })
          .join('');
      }

      function extractPageName(url) {
        if (!url) return 'Unknown';

        try {
          const urlObj = new URL(url);
          const pathname = urlObj.pathname;

          // Map common paths to friendly names
          const pageMap = {
            '/': 'Homepage',
            '/index.html': 'Homepage',
            '/spoon-saver': 'Spoon Saver',
            '/spoon-saver.html': 'Spoon Saver',
            '/predict-flares': 'Predict Flares',
            '/predict-flares.html': 'Predict Flares',
            '/foggy-minds': 'Foggy Minds',
            '/foggy-minds.html': 'Foggy Minds',
            '/appointment-prep': 'Appointment Prep',
            '/appointment-prep.html': 'Appointment Prep',
            '/doctor-proof': 'Doctor Proof',
            '/doctor-proof.html': 'Doctor Proof',
            '/find-triggers': 'Find Triggers',
            '/find-triggers.html': 'Find Triggers',
            // New prediction depth test pages
            '/flare-forecast': 'Flare Forecast',
            '/flare-forecast.html': 'Flare Forecast',
            '/top-suspect': 'Top Suspect',
            '/top-suspect.html': 'Top Suspect',
            '/crash-prevention': 'Crash Prevention',
            '/crash-prevention.html': 'Crash Prevention',
          };

          return pageMap[pathname] || pathname.replace(/\//g, '') || 'Homepage';
        } catch (e) {
          return 'Unknown';
        }
      }

      function cleanElementText(text) {
        if (!text) return '';
        // Remove material icon names (including truncated versions) and extra whitespace
        return text
          .replace(/arrow_\w*/gi, '') // Handles arrow_forward, arrow_forwa, arrow_back, etc.
          .replace(/\s+/g, ' ')
          .trim();
      }

      function getPageColor(pageName) {
        const colorMap = {
          Homepage: 'bg-accent-purple/20 text-primary',
          'Spoon Saver': 'bg-accent-peach/20 text-accent-peach',
          'Predict Flares': 'bg-accent-blue/20 text-blue-700',
          'Foggy Minds': 'bg-accent-mint/20 text-green-700',
          'Appointment Prep': 'bg-accent-rose/20 text-rose-700',
          'Doctor Proof': 'bg-yellow-100 text-yellow-700',
          'Find Triggers': 'bg-indigo-100 text-indigo-700',
          // New prediction depth test pages
          'Flare Forecast': 'bg-accent-purple/20 text-purple-700',
          'Top Suspect': 'bg-accent-peach/20 text-orange-700',
          'Crash Prevention': 'bg-accent-mint/20 text-teal-700',
        };
        return colorMap[pageName] || 'bg-primary-light text-primary';
      }

      // ===== REFERRER BREAKDOWN MODAL =====
      function showReferrerBreakdown(campaign, content) {
        const modal = document.getElementById('referrerModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalSubtitle = document.getElementById('modalSubtitle');
        const breakdown = document.getElementById('referrerBreakdown');

        // Set title
        modalTitle.textContent = 'Referrer Breakdown';
        modalSubtitle.textContent = `${campaign} - ${content}`;

        // Filter events and signups by campaign and content
        const campaignEvents = allEvents.filter((e) => {
          const eCampaign = e.utm_campaign || 'Direct';
          const eContent = e.utm_content || '-';
          return eCampaign === campaign && eContent === content;
        });

        const campaignSignups = allSignups.filter((s) => {
          const sCampaign = s.utm_campaign || 'Direct';
          const sContent = s.utm_content || '-';
          return sCampaign === campaign && sContent === content;
        });

        // Collect all referrers
        const allReferrers = [
          ...campaignEvents.map((e) => e.referrer),
          ...campaignSignups.map((s) => s.referrer),
        ];

        // Group referrers by value and count
        const referrerCounts = {};
        allReferrers.forEach((ref) => {
          const key = ref || null;
          referrerCounts[key] = (referrerCounts[key] || 0) + 1;
        });

        // Sort by count (descending)
        const sortedReferrers = Object.entries(referrerCounts)
          .map(([ref, count]) => ({ referrer: ref, count }))
          .sort((a, b) => b.count - a.count);

        // Render breakdown
        if (sortedReferrers.length === 0) {
          breakdown.innerHTML = `
          <p class="text-text-muted text-center py-8">No referrer data available for this campaign.</p>
        `;
        } else {
          breakdown.innerHTML = `
          <div class="space-y-3">
            ${sortedReferrers
              .map((r) => {
                const displayRef =
                  r.referrer === null || r.referrer === ''
                    ? '<span class="text-text-muted italic">null</span>'
                    : escapeHtml(r.referrer);
                return `
                <div class="flex items-center justify-between p-4 bg-bg-cream rounded-xl border border-primary/5">
                  <div class="flex-1 min-w-0">
                    <p class="text-sm text-text-muted mb-1">Referrer</p>
                    <p class="font-medium text-primary break-all">${displayRef}</p>
                  </div>
                  <div class="ml-4 text-right">
                    <p class="text-sm text-text-muted mb-1">Count</p>
                    <p class="font-display text-2xl font-bold text-accent-purple">${r.count}</p>
                  </div>
                </div>
              `;
              })
              .join('')}
          </div>
        `;
        }

        modal.classList.remove('hidden');
      }

      function closeReferrerModal() {
        document.getElementById('referrerModal').classList.add('hidden');
      }

      // Close modal on outside click (setup after DOM is ready)
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', setupModalClose);
      } else {
        setupModalClose();
      }

      function setupModalClose() {
        const modal = document.getElementById('referrerModal');
        if (modal) {
          modal.addEventListener('click', function (e) {
            if (e.target === this) {
              closeReferrerModal();
            }
          });
        }
        // Also setup user modal close
        const userModal = document.getElementById('userModal');
        if (userModal) {
          userModal.addEventListener('click', function (e) {
            if (e.target === this) {
              closeUserModal();
            }
          });
        }
      }

      // ===== FUNNEL VISUALIZATION =====
      function renderFunnel(events, signups) {
        const pageViews = events.filter((e) => e.event_type === 'page_view');
        const clicks = events.filter((e) => e.event_type === 'cta_click');

        // Count unique sessions
        const viewSessions = new Set(pageViews.map((e) => e.session_id)).size;
        const clickSessions = new Set(clicks.map((e) => e.session_id)).size;
        const signupCount = signups.length;

        // Update funnel numbers
        document.getElementById('funnelViews').textContent = pageViews.length;
        document.getElementById('funnelViewsSessions').textContent =
          `${viewSessions} unique sessions`;
        document.getElementById('funnelClicks').textContent = clicks.length;
        document.getElementById('funnelSignups').textContent = signupCount;

        // Calculate rates
        const clickRate =
          viewSessions > 0
            ? ((clickSessions / viewSessions) * 100).toFixed(1)
            : 0;
        const convRate =
          clickSessions > 0
            ? ((signupCount / clickSessions) * 100).toFixed(1)
            : 0;
        const overallConv =
          viewSessions > 0
            ? ((signupCount / viewSessions) * 100).toFixed(2)
            : 0;

        document.getElementById('funnelClickRate').textContent =
          `${clickRate}%`;
        document.getElementById('funnelConvRate').textContent = `${convRate}%`;
        document.getElementById('funnelOverallConv').textContent =
          `${overallConv}%`;

        // Calculate avg clicks before signup (from signup sessions only)
        const signupEmails = signups.map((s) => s.email);
        const signupEvents = events.filter(
          (e) =>
            e.event_type === 'signup_complete' &&
            signupEmails.some(
              (email) =>
                e.element_text && e.element_text.includes(email.split('@')[0])
            )
        );
        const signupSessionIds = new Set(signupEvents.map((e) => e.session_id));

        let totalClicksBeforeSignup = 0;
        signupSessionIds.forEach((sessionId) => {
          const sessionClicks = events.filter(
            (e) => e.session_id === sessionId && e.event_type === 'cta_click'
          );
          totalClicksBeforeSignup += sessionClicks.length;
        });
        const avgClicks =
          signupSessionIds.size > 0
            ? (totalClicksBeforeSignup / signupSessionIds.size).toFixed(1)
            : '-';
        document.getElementById('funnelAvgClicks').textContent = avgClicks;

        // Calculate avg time to conversion
        let totalTime = 0;
        let validTimes = 0;
        signupSessionIds.forEach((sessionId) => {
          const sessionEvents = events
            .filter((e) => e.session_id === sessionId)
            .sort((a, b) => new Date(a.created_at) - new Date(b.created_at));

          if (sessionEvents.length >= 2) {
            const firstEvent = new Date(sessionEvents[0].created_at);
            const signupEvent = sessionEvents.find(
              (e) => e.event_type === 'signup_complete'
            );
            if (signupEvent) {
              const timeDiff =
                (new Date(signupEvent.created_at) - firstEvent) / 1000; // seconds
              totalTime += timeDiff;
              validTimes++;
            }
          }
        });
        const avgTime =
          validTimes > 0 ? formatDuration(totalTime / validTimes) : '-';
        document.getElementById('funnelTimeToConv').textContent = avgTime;

        // Adjust funnel bar widths based on ratios
        const clickBarWidth = Math.max(20, Math.min(100, clickRate * 2));
        const signupBarWidth = Math.max(15, Math.min(80, convRate * 2));
        document.getElementById('funnelClicksBar').style.width =
          `${clickBarWidth}%`;
        document.getElementById('funnelSignupsBar').style.width =
          `${signupBarWidth}%`;
      }

      function formatDuration(seconds) {
        if (seconds < 60) return `${Math.round(seconds)}s`;
        if (seconds < 3600)
          return `${Math.round(seconds / 60)}m ${Math.round(seconds % 60)}s`;
        return `${Math.round(seconds / 3600)}h ${Math.round((seconds % 3600) / 60)}m`;
      }

      // Format date in UTC for consistency across timezones
      function formatUTCDate(isoString) {
        const d = new Date(isoString);
        const months = [
          'Jan',
          'Feb',
          'Mar',
          'Apr',
          'May',
          'Jun',
          'Jul',
          'Aug',
          'Sep',
          'Oct',
          'Nov',
          'Dec',
        ];
        const month = months[d.getUTCMonth()];
        const day = d.getUTCDate();
        const hours = d.getUTCHours().toString().padStart(2, '0');
        const mins = d.getUTCMinutes().toString().padStart(2, '0');
        return `${month} ${day}, ${hours}:${mins} UTC`;
      }

      // Format time only in UTC
      function formatUTCTime(isoString) {
        const d = new Date(isoString);
        const hours = d.getUTCHours().toString().padStart(2, '0');
        const mins = d.getUTCMinutes().toString().padStart(2, '0');
        const secs = d.getUTCSeconds().toString().padStart(2, '0');
        return `${hours}:${mins}:${secs} UTC`;
      }

      // ===== USER JOURNEY MODAL =====
      async function showUserJourney(email) {
        const modal = document.getElementById('userModal');
        modal.classList.remove('hidden');

        // Set email in modal
        document.getElementById('userModalEmail').textContent = email;
        document.getElementById('userJourneyTimeline').innerHTML = `
          <p class="text-text-muted text-center py-8">
            <span class="material-symbols-outlined animate-spin">progress_activity</span>
            <br>Loading journey...
          </p>
        `;

        // Find signup data
        const signup = allSignups.find((s) => s.email === email);
        if (!signup) {
          document.getElementById('userJourneyTimeline').innerHTML = `
            <p class="text-text-muted text-center py-8">Signup data not found.</p>
          `;
          return;
        }

        // Find session ID from signup_complete event
        const signupEvent = allEvents.find(
          (e) =>
            e.event_type === 'signup_complete' &&
            e.element_text &&
            e.element_text.includes(email.split('@')[0])
        );

        if (!signupEvent) {
          // No session tracking, show signup info only
          renderUserJourneyNoSession(signup);
          return;
        }

        const sessionId = signupEvent.session_id;

        // Get all events for this session
        const sessionEvents = allEvents
          .filter((e) => e.session_id === sessionId)
          .sort((a, b) => new Date(a.created_at) - new Date(b.created_at));

        renderUserJourney(signup, sessionEvents);
      }

      function renderUserJourneyNoSession(signup) {
        // Update stats
        document.getElementById('userStatsEvents').textContent = '1';
        document.getElementById('userStatsClicks').textContent = '-';
        document.getElementById('userStatsTime').textContent = '-';
        document.getElementById('userStatsSource').textContent =
          signup.utm_source || 'Direct';

        // Attribution
        document.getElementById('userAttrCampaign').textContent =
          signup.utm_campaign || 'Direct';
        document.getElementById('userAttrContent').textContent =
          signup.utm_content || '-';
        document.getElementById('userAttrUrl').textContent =
          signup.landing_url || '-';
        document.getElementById('userAttrDevice').textContent = parseUserAgent(
          signup.user_agent
        );

        // Simple timeline
        const date = formatUTCDate(signup.created_at);

        document.getElementById('userJourneyTimeline').innerHTML = `
          <div class="journey-step step-signup">
            <div class="flex items-start justify-between">
              <div>
                <p class="font-semibold text-primary flex items-center gap-2">
                  <span class="material-symbols-outlined text-accent-mint text-lg">check_circle</span>
                  Beta Signup
                </p>
                <p class="text-text-muted text-sm mt-1">${escapeHtml(signup.email)}</p>
              </div>
              <p class="text-xs text-text-muted">${date}</p>
            </div>
          </div>
          <p class="text-text-muted text-sm mt-4 italic">
            Note: Session tracking data not available for this signup.
          </p>
        `;
      }

      function renderUserJourney(signup, sessionEvents) {
        // Calculate stats
        const totalEvents = sessionEvents.length;
        const clickEvents = sessionEvents.filter(
          (e) => e.event_type === 'cta_click'
        );
        const totalClicks = clickEvents.length;

        // Time to signup
        let timeToSignup = '-';
        if (sessionEvents.length >= 2) {
          const firstEvent = new Date(sessionEvents[0].created_at);
          const lastSignup = sessionEvents.find(
            (e) => e.event_type === 'signup_complete'
          );
          if (lastSignup) {
            const timeDiff =
              (new Date(lastSignup.created_at) - firstEvent) / 1000;
            timeToSignup = formatDuration(timeDiff);
          }
        }

        // Update stats
        document.getElementById('userStatsEvents').textContent = totalEvents;
        document.getElementById('userStatsClicks').textContent = totalClicks;
        document.getElementById('userStatsTime').textContent = timeToSignup;
        document.getElementById('userStatsSource').textContent =
          signup.utm_source || 'Direct';

        // Attribution
        document.getElementById('userAttrCampaign').textContent =
          signup.utm_campaign || 'Direct';
        document.getElementById('userAttrContent').textContent =
          signup.utm_content || '-';
        document.getElementById('userAttrUrl').textContent =
          signup.landing_url || '-';
        document.getElementById('userAttrDevice').textContent = parseUserAgent(
          signup.user_agent
        );

        // Build timeline
        let prevTime = null;
        const timelineHtml = sessionEvents
          .map((event, index) => {
            const eventTime = new Date(event.created_at);
            const timeStr = formatUTCTime(event.created_at);

            // Calculate time delta
            let timeDelta = '';
            if (prevTime) {
              const delta = (eventTime - prevTime) / 1000;
              timeDelta = `+${formatDuration(delta)}`;
            }
            prevTime = eventTime;

            // Determine step type and styling
            let stepClass = '';
            let icon = '';
            let title = '';
            let subtitle = '';

            if (event.event_type === 'page_view') {
              stepClass = '';
              icon =
                '<span class="material-symbols-outlined text-accent-purple text-lg">visibility</span>';
              title = 'Page View';
              subtitle = extractPageName(event.page_url);
            } else if (event.event_type === 'cta_click') {
              stepClass = 'step-click';
              icon =
                '<span class="material-symbols-outlined text-accent-peach text-lg">touch_app</span>';
              title = 'CTA Click';
              subtitle =
                cleanElementText(event.element_text) ||
                event.element_id ||
                'Unknown button';
            } else if (event.event_type === 'signup_complete') {
              stepClass = 'step-signup';
              icon =
                '<span class="material-symbols-outlined text-accent-mint text-lg">check_circle</span>';
              title = '‚ú® Beta Signup';
              subtitle = event.element_text || signup.email;
            }

            return `
            <div class="journey-step ${stepClass}">
              <div class="flex items-start justify-between gap-4">
                <div class="flex-1 min-w-0">
                  <p class="font-semibold text-primary flex items-center gap-2">
                    ${icon}
                    ${title}
                  </p>
                  <p class="text-text-muted text-sm mt-1 truncate">${escapeHtml(subtitle)}</p>
                  ${event.element_id ? `<p class="text-xs text-text-muted/70 font-mono mt-0.5">${escapeHtml(event.element_id)}</p>` : ''}
                </div>
                <div class="text-right flex-shrink-0">
                  <p class="text-xs text-text-muted">${timeStr}</p>
                  ${timeDelta ? `<p class="text-xs text-accent-purple font-medium">${timeDelta}</p>` : '<p class="text-xs text-text-muted">Start</p>'}
                </div>
              </div>
            </div>
          `;
          })
          .join('');

        document.getElementById('userJourneyTimeline').innerHTML = timelineHtml;
      }

      function parseUserAgent(ua) {
        if (!ua) return 'Unknown';
        if (ua.includes('iPhone') || ua.includes('iPad')) return 'iOS';
        if (ua.includes('Android')) return 'Android';
        if (ua.includes('Mac')) return 'Mac';
        if (ua.includes('Windows')) return 'Windows';
        if (ua.includes('Linux')) return 'Linux';
        return 'Unknown';
      }

      function closeUserModal() {
        document.getElementById('userModal').classList.add('hidden');
      }
    </script>
  </body>
</html>
